//
// Created by Joe Chrisman on 4/11/23.
//

#ifndef KARL_EVAL_H
#define KARL_EVAL_H

#include "Defs.h"
#include "Position.h"

// forward declarations
class Position;
#include "MoveGen.h"
class MoveGen;

typedef int Score;
inline constexpr Score TIMEOUT = INT_MIN;
inline constexpr Score MAX_SCORE = 30000;
inline constexpr Score MIN_SCORE = -30000;
inline constexpr Score CONTEMPT = 250;

class Evaluator
{
public:
    Evaluator(Position& position, MoveGen& gen);
    Score evaluate();

private:
    Position& position;
    MoveGen& moveGen;

    float getOpeningWeight();

    template<bool isWhite>
    Score getPawnStructureScore(const U64 friendlyPawns, const U64 enemyPawns);

    struct PawnStructure
    {
        bool isValid;
        Score whiteAdvantage;
        U64 blackPawns;
        U64 whitePawns;
    };

    PawnStructure pawnStructures[8192];

    static constexpr Score ISOLATED_PAWN_PENALTY = -20;
    static constexpr Score DOUBLED_PAWN_PENALTY = -10;

    static constexpr Score KING_ACTIVITY_SCORES[64] = {
            -50, -50, -40, -40, -40, -40, -50, -50,
            -50, -20, -10,   0,   0, -10, -20, -50,
            -40, -10,  20,  30,  30,  20, -10, -40,
            -40,   0,  30,  50,  50,  30,   0, -40,
            -40,   0,  30,  50,  50,  30,   0, -40,
            -40, -10,  20,  30,  30,  20, -10, -40,
            -50, -20, -10,   0,   0, -10, -20, -50,
            -50, -50, -40, -40, -40, -40, -50, -50,
    };

    static constexpr Score WHITE_KING_SAFETY_SCORES[64] = {
            -20, -20, -20, -20, -20, -20, -20, -20,
            -20, -30, -30, -30, -30, -30, -30, -20,
            -20, -30, -40, -50, -50, -40, -30, -20,
            -20, -30, -40, -50, -50, -40, -30, -20,
            -20, -30, -40, -50, -50, -40, -30, -20,
            -20, -20, -20, -20, -20, -20, -20, -20,
              0,   0,   0, -50, -50, -50,   0,   0,
             30,  70,  20, -50, -20, -50,  70,  30,
    };

    static constexpr Score BLACK_KING_SAFETY_SCORES[64] = {
             30,  70,  20, -50, -20, -50,  70,  30,
              0,   0,   0, -50, -50, -50,   0,   0,
            -20, -20, -20, -20, -20, -20, -20, -20,
            -20, -30, -40, -50, -50, -40, -30, -20,
            -20, -30, -40, -50, -50, -40, -30, -20,
            -20, -30, -40, -50, -50, -40, -30, -20,
            -20, -30, -30, -30, -30, -30, -30, -20,
            -20, -20, -20, -20, -20, -20, -20, -20,
    };

    static constexpr Score WHITE_PASSED_PAWN_SCORES[64] = {
            0,   0,   0,   0,   0,   0,   0,   0,
           99,  99,  99,  99,  99,  99,  99,  99,
           80,  80,  80,  80,  80,  80,  80,  80,
           60,  60,  60,  60,  60,  60,  60,  60,
           50,  50,  50,  50,  50,  50,  50,  50,
           30,  30,  30,  30,  30,  30,  30,  30,
           20,  20,  20,  20,  20,  20,  20,  20,
            0,   0,   0,   0,   0,   0,   0,   0
    };

    static constexpr Score BLACK_PASSED_PAWN_SCORES[64] = {
             0,   0,   0,   0,   0,   0,   0,   0,
            20,  20,  20,  20,  20,  20,  20,  20,
            30,  30,  30,  30,  30,  30,  30,  30,
            50,  50,  50,  50,  50,  50,  50,  50,
            60,  60,  60,  60,  60,  60,  60,  60,
            80,  80,  80,  80,  80,  80,  80,  80,
            99,  99,  99,  99,  99,  99,  99,  99,
             0,   0,   0,   0,   0,   0,   0,   0
    };
};

inline constexpr Score MATERIAL_SCORES[13] = {
        0,    // NULL_PIECE
        100,  // WHITE_PAWN
        310,  // WHITE_KNIGHT
        380,  // WHITE_BISHOP
        500,  // WHITE_ROOK
        940,  // WHITE_QUEEN
        0,    // WHITE_KING
        -100, // BLACK_PAWN
        -310, // BLACK_KNIGHT
        -380, // BLACK_BISHOP
        -500, // BLACK_ROOK
        -940, // BLACK_QUEEN
        0     // BLACK_KING
};

inline constexpr Score PLACEMENT_SCORES[13][64] = {
        // NULL_PIECE
        {
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
        },
        // WHITE_PAWN
        {

                0,   0,   0,   0,   0,   0,   0,   0,
                0,  20,  20,  20,  20,  20,  20,   0,
                0,   0,  10,  10,  10,  10,   0,   0,
                0,   0,  15,  15,  15,  15,   0,   0,
                0,   0,  10,  20,  20,   5,   0,   0,
                3,   3,   8,   2,   2,  -5,   3,   3,
                5,   5,   5, -20, -20,   5,   5,   5,
                0,   0,   0,   0,   0,   0,   0,   0
        },
        // WHITE_KNIGHT
        {
                -10, -10,  -5,  -5,  -5,  -5, -10, -10,
                -10,   5,   5,   5,   5,   5,   5, -10,
                 -5,   5,  15,  15,  15,  15,   5,  -5,
                 -5,   0,  15,  20,  20,  15,   0,  -5,
                 -5,   0,  15,  20,  20,  15,   0,  -5,
                 -5,   0,  15,  15,  15,  15,   0,  -5,
                -20,  -5,  -5,  -2,  -2,  -5,   0, -20,
                -20, -20,  -5,  -5,  -5,  -5, -20, -20
        },
        // WHITE_BISHOP
        {
                10,   0,   0,   0,   0,   0,   0,  10,
                10,  10,   2,   2,   2,   2,  10,  10,
                 0,  10,  15,  15,  15,  15,  10,   0,
                 0,   0,  10,  10,  10,  10,   0,   0,
                 0,   5,  15,   7,   7,  15,   5,   0,
                 5,  10,  10,   5,   5,  10,  10,   5,
                10,  10,   5,   5,   5,   5,  10,  10,
                10,  -5, -20, -10, -10, -20,  -5,  10
        },
        // WHITE_ROOK
        {
                  5,   5,   5,   5,   5,   5,   5,   5,
                 15,  15,  20,  20,  20,  20,  15,  15,
                  5,   5,   5,   5,   5,   5,   5,   5,
                 -5,   0,   0,   0,   0,   0,   0,  -5,
                 -5,   0,   0,   0,   0,   0,   0,  -5,
                 -5,   0,   0,   0,   0,   0,   0,  -5,
                 -5,   0,   0,   0,   0,   0,   0,  -5,
                -20,   0,  10,  15,  15,  10,   0, -20,
        },
        // WHITE_QUEEN
        {
                 5,  10,  10,  10,  10,  10,  10,   5,
                20,  20,  20,  20,  20,  20,  20,  20,
                 5,  10,  10,  10,  10,  10,  10,   5,
                 0,   0,   0,   0,   0,   0,   0,   0,
                 0,   0,   0,   0,   0,   0,   0,   0,
                 0,   5,   0,   0,   0,   0,   5,   0,
                 0,   0,   0,   0,   0,   0,   0,   0,
                 0,   0,   0,  20,   0,   0,   0,   0,
        },
        // WHITE_KING
        {
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
        },
        // BLACK_PAWN
        {
                 0,   0,   0,   0,   0,   0,   0,   0,
                -5,  -5,  -5,  20,  20,  -5,  -5,  -5,
                -3,  -3,  -8,  -2,  -2,   5,  -3,  -3,
                 0,   0, -10, -20, -20,  -5,   0,   0,
                 0,   0, -15, -15, -15, -15,   0,   0,
                 0,   0, -10, -10, -10, -10,   0,   0,
                 0, -20, -20, -20, -20, -20, -20,   0,
                 0,   0,   0,   0,   0,   0,   0,   0
        },
        // BLACK_KNIGHT
        {
                20,  20,   5,   5,   5,   5,  20,  20,
                20,   5,   5,   2,   2,   5,   0,  20,
                 5,   0, -15, -15, -15, -15,   0,   5,
                 5,   0, -15, -20, -20, -15,   0,   5,
                 5,   0, -15, -20, -20, -15,   0,   5,
                 5,  -5, -15, -15, -15, -15,  -5,   5,
                10,  -5,  -5,  -5,  -5,  -5,  -5,  10,
                10,  10,   5,   5,   5,   5,  10,  10,
        },
        // BLACK_BISHOP
        {
                -10,   5,  20,  10,  10,  20,   5, -10,
                -10, -10,  -5,  -5,  -5,  -5, -10, -10,
                 -5, -10, -10,  -5,  -5, -10, -10,  -5,
                  0,  -5, -15,  -7,  -7, -15,  -5,   0,
                  0,   0, -10, -10, -10, -10,   0,   0,
                  0, -10, -15, -15, -15, -15, -10,   0,
                -10, -10,  -2,  -2,  -2,  -2, -10, -10,
                -10,   0,   0,   0,   0,   0,   0, -10,
        },
        // BLACK_ROOK
        {
                 20,   0, -10, -15, -15, -10,   0,  20,
                  5,   0,   0,   0,   0,   0,   0,   5,
                  5,   0,   0,   0,   0,   0,   0,   5,
                  5,   0,   0,   0,   0,   0,   0,   5,
                  5,   0,   0,   0,   0,   0,   0,   5,
                 -5,  -5,  -5,  -5,  -5,  -5,  -5,  -5,
                -15, -15, -20, -20, -20, -20, -15, -15,
                 -5,  -5,  -5,  -5,  -5,  -5,  -5,  -5,
        },
        // BLACK_QUEEN
        {
                  0,   0,   0, -20,   0,   0,   0,   0,
                  0,   0,   0,   0,   0,   0,   0,   0,
                  0,  -5,   0,   0,   0,   0,  -5,   0,
                  0,   0,   0,   0,   0,   0,   0,   0,
                  0,   0,   0,   0,   0,   0,   0,   0,
                 -5, -10, -10, -10, -10, -10, -10,  -5,
                -20, -20, -20, -20, -20, -20, -20, -20,
                 -5, -10, -10, -10, -10, -10, -10,  -5,
        },
        // BLACK_KING
        {
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
                0,   0,   0,   0,   0,   0,   0,   0,
        },
};


#endif //KARL_EVAL_H
